<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DealFlow - Real-Time Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      window.DEALFLOW_API_BASE = 'https://dealflow-ai-streams.onrender.com';
    </script>
    <style>
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .buyer-alert {
            animation: pulse 0.5s ease-in-out, slideIn 0.3s ease-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .live-indicator {
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">DealFlow</h1>
                    <p class="text-gray-400">Real-Time Stream Monitor</p>
                </div>
                <div id="statusIndicator" class="hidden">
                    <div class="flex items-center gap-2 bg-green-900 px-4 py-2 rounded-lg">
                        <div class="w-3 h-3 bg-green-500 rounded-full live-indicator"></div>
                        <span class="font-semibold">LIVE MONITORING</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clean Input Bar -->
        <div class="mb-8">
            <div class="relative max-w-2xl mx-auto">
                <input
                    type="text"
                    id="urlInput"
                    placeholder="Paste Whatnot URL and press Enter..."
                    class="w-full px-6 py-4 bg-gray-900 border border-gray-700 rounded-2xl text-white text-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                    onkeydown="handleKeyPress(event)"
                />
                <div id="status" class="mt-3 text-center"></div>
            </div>
        </div>

        <!-- Clean Stats Bar -->
        <div id="stats" class="hidden flex items-center justify-center gap-8 mb-8">
            <!-- Primary: Buyers (Big and Bold) -->
            <div class="text-center">
                <div class="text-6xl font-bold text-green-400 mb-1" id="totalBuyers">0</div>
                <div class="text-sm text-gray-400 uppercase tracking-wide">Buyers Detected</div>
            </div>

            <!-- Secondary Stats (Inline) -->
            <div class="flex items-center gap-6 text-sm">
                <div class="text-center">
                    <div class="text-2xl font-semibold text-blue-400" id="totalMessages">0</div>
                    <div class="text-gray-500">Messages</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-semibold text-purple-400" id="estimatedValue">$0</div>
                    <div class="text-gray-500">Value</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-semibold text-red-400" id="streamTime">0:00</div>
                    <div class="text-gray-500">Time</div>
                </div>
            </div>
        </div>

        <!-- Clean Single Column Layout -->
        <div id="mainView" class="hidden max-w-4xl mx-auto">
            <!-- Floating Stop Button -->
            <button
                id="stopBtn"
                onclick="stopMonitoring()"
                class="fixed top-6 right-6 z-50 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full font-semibold shadow-lg transform hover:scale-105 transition-all hidden">
                🛑 Stop Monitoring
            </button>

            <!-- Buyers Panel (Primary Focus) -->
            <div class="bg-gray-900 rounded-2xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-3">
                        🔥 Buyers Detected
                        <span class="text-sm font-normal text-gray-400 bg-gray-800 px-3 py-1 rounded-full" id="buyerCount">0</span>
                    </h2>
                    <button
                        id="exportBtn"
                        onclick="exportBuyers()"
                        class="bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        📥 Export CSV
                    </button>
                </div>

                <!-- Empty State: Pulsing Animation -->
                <div id="noBuyers" class="bg-gray-950 rounded-xl p-12 text-center">
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                    <div class="text-lg font-medium text-gray-300 mb-2">Listening for buyers...</div>
                    <div class="text-sm text-gray-500">Real-time detection active</div>
                </div>

                <!-- Buyers List -->
                <div id="buyersList" class="space-y-4 hidden">
                </div>
            </div>

            <!-- Collapsed Chat Preview -->
            <div class="bg-gray-900 rounded-2xl p-6">
                <button
                    onclick="toggleChat()"
                    class="w-full flex items-center justify-between text-left group">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                        <span class="font-semibold">Live Chat</span>
                        <span class="text-sm text-gray-400 bg-gray-800 px-2 py-1 rounded">Updates every 1.5s</span>
                    </div>
                    <div class="text-gray-400 group-hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </button>

                <div id="chatFeed" class="hidden mt-4 bg-gray-950 rounded-lg p-4 max-h-96 overflow-y-auto space-y-2">
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for alerts -->
    <audio id="alertSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSh+zPLaizsIHGO14+OWRAwWardwx1wvBi6Cz/LekTsIF2W74N2YSQwUYLTi7qVTEApBnN3yuW0dBSl7yvLbjjkIGmG24OCcSwwWZbjnzWUrBi+A0PLgk0AKFl+24uahUhAIQJne77F4IwYqfMvy3I02CA==" type="audio/wav">
    </audio>

    <script>
        let ws = null;
        let isMonitoring = false;
        let sessionId = null;
        let allBuyers = [];
        let messageCount = 0;
        let startTime = null;
        let timerInterval = null;

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function toggleMonitoring() {
            if (!isMonitoring) {
                await startMonitoring();
            } else {
                await stopMonitoring();
            }
        }

        async function startMonitoring() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            const status = document.getElementById('status');

            if (!url) {
                status.innerHTML = '<span class="text-red-400">Please enter a Whatnot stream URL</span>';
                return;
            }

            sessionId = generateSessionId();
            startTime = Date.now();

            // Update UI
            document.getElementById('statusIndicator').classList.remove('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('stats').classList.remove('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            status.innerHTML = '<span class="text-green-400">🚀 Connecting to stream...</span>';

            // Start timer
            timerInterval = setInterval(updateTimer, 1000);

            // Connect WebSocket
            connectWebSocket();

            // Start backend monitoring
            try {
                const response = await fetch(`${window.DEALFLOW_API_BASE || window.location.origin}/api/start-monitoring`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, sessionId })
                });

                const data = await response.json();
                
                if (data.status === 'monitoring') {
                    isMonitoring = true;
                    status.innerHTML = '<span class="text-green-400">✅ Monitoring active - watching for buyers...</span>';
                } else {
                    throw new Error('Failed to start monitoring');
                }

            } catch (error) {
                status.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
                stopMonitoring();
            }
        }

        async function stopMonitoring() {
            isMonitoring = false;

            // Update UI
            document.getElementById('statusIndicator').classList.add('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('status').innerHTML = '<span class="text-gray-400">Stopped</span>';

            // Reset input
            document.getElementById('urlInput').value = '';

            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // Close WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }

            // Stop backend monitoring
            if (sessionId) {
                await fetch(`${window.DEALFLOW_API_BASE || window.location.origin}/api/stop-monitoring`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
            }
        }

        function connectWebSocket() {
            const apiBase = window.DEALFLOW_API_BASE || window.location.origin;
            const wsProtocol = apiBase.startsWith('https') ? 'wss' : 'ws';
            const host = new URL(apiBase).host;
            ws = new WebSocket(`${wsProtocol}://${host}`);

            ws.onopen = () => {
                console.log('✅ WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'buyer_detected') {
                    handleBuyerAlert(data.buyer, data.stats);
                } else if (data.type === 'new_message') {
                    handleNewMessage(data.message);
                }
            };

            ws.onerror = (error) => {
                console.error('❌ WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('🔌 WebSocket disconnected');
            };
        }

        function handleBuyerAlert(buyer, stats) {
            console.log('💰 BUYER ALERT:', buyer);

            // Play sound
            document.getElementById('alertSound').play().catch(() => {});

            // Update stats
            document.getElementById('totalBuyers').textContent = stats.totalBuyers;
            document.getElementById('estimatedValue').textContent = `$${stats.estimatedValue}`;
            document.getElementById('buyerCount').textContent = stats.totalBuyers;

            // Enable export button when we have buyers
            const exportBtn = document.getElementById('exportBtn');
            if (stats.totalBuyers > 0) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = `📥 Export ${stats.totalBuyers} Buyer${stats.totalBuyers > 1 ? 's' : ''}`;
            }

            // Add to buyers list
            allBuyers.push(buyer);

            // Hide "no buyers" message
            document.getElementById('noBuyers')?.remove();

            const buyersList = document.getElementById('buyersList');
            const buyerDiv = document.createElement('div');
            buyerDiv.className = 'bg-gradient-to-br from-green-900 to-green-800 border border-green-600 rounded-xl p-6 transform hover:scale-[1.02] transition-all duration-200';
            buyerDiv.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            ${buyer.buyerNumber}
                        </div>
                        <div>
                            <div class="text-green-300 font-bold text-lg">${buyer.username}</div>
                            <div class="text-xs text-gray-300">${new Date(buyer.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                    <span class="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-bold">
                        ${Math.round(buyer.confidence * 100)}% CONFIDENCE
                    </span>
                </div>
                <div class="text-white text-base mb-3 italic">"${buyer.message}"</div>
                <div class="text-sm text-green-300 flex items-center gap-2">
                    <span>🎯</span>
                    <span>${buyer.reason}</span>
                </div>
            `;

            // Show only last 3 buyers, remove oldest
            while (buyersList.children.length >= 3) {
                buyersList.removeChild(buyersList.lastChild);
            }

            buyersList.insertBefore(buyerDiv, buyersList.firstChild);
        }

        function handleNewMessage(message) {
            messageCount++;
            document.getElementById('totalMessages').textContent = messageCount;

            const chatFeed = document.getElementById('chatFeed');
            const msgDiv = document.createElement('div');
            
            // Determine styling: Green border = buyer, Orange glow = question
            let className = 'chat-message bg-gray-800 rounded p-3';
            if (message.isBuyer) {
                className += ' border-l-4 border-green-500';
            } else if (message.isQuestion) {
                className += ' border-l-4 border-orange-500 bg-orange-900 bg-opacity-20';
            }
            
            msgDiv.className = className;
            msgDiv.innerHTML = `
                <div class="flex items-start gap-2">
                    <div class="flex-1">
                        <span class="text-blue-400 font-semibold">${message.username}</span>
                        <span class="text-gray-300 ml-2">${message.message}</span>
                    </div>
                    ${message.isBuyer ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full">💰</span>' : ''}
                    ${message.isQuestion ? '<span class="text-xs bg-orange-500 text-white px-2 py-1 rounded-full">❓</span>' : ''}
                </div>
                <div class="text-xs text-gray-500 mt-1">${new Date(message.timestamp).toLocaleTimeString()}</div>
            `;

            chatFeed.insertBefore(msgDiv, chatFeed.firstChild);

            // Keep only last 100 messages
            while (chatFeed.children.length > 100) {
                chatFeed.removeChild(chatFeed.lastChild);
            }
        }

        function updateTimer() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('streamTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function exportBuyers() {
            if (allBuyers.length === 0) {
                alert('No buyers to export');
                return;
            }

            const headers = ['#', 'Username', 'Message', 'Confidence', 'Timestamp'];
            const rows = allBuyers.map(buyer => [
                buyer.buyerNumber,
                buyer.username,
                buyer.message.replace(/,/g, ';'),
                `${Math.round(buyer.confidence * 100)}%`,
                new Date(buyer.timestamp).toLocaleString()
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dealflow-buyers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // New UI Functions
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                toggleMonitoring();
            }
        }

        function toggleChat() {
            const chatFeed = document.getElementById('chatFeed');
            const isHidden = chatFeed.classList.contains('hidden');

            if (isHidden) {
                chatFeed.classList.remove('hidden');
            } else {
                chatFeed.classList.add('hidden');
            }
        }

        // Auto-paste detection and start
        document.getElementById('urlInput').addEventListener('paste', (event) => {
            setTimeout(() => {
                const url = document.getElementById('urlInput').value.trim();
                if (url.includes('whatnot.com/live/') && !isMonitoring) {
                    setTimeout(() => toggleMonitoring(), 500); // Small delay for UX
                }
            }, 100);
        });

        // Cleanup on page close
        window.addEventListener('beforeunload', () => {
            if (isMonitoring) {
                stopMonitoring();
            }
        });
    </script>
</body>
</html>

