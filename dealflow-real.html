<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DealFlow - Stream Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-4xl font-bold mb-2">DealFlow</h1>
            <p class="text-gray-400">Analyze Whatnot Streams - See What You Missed</p>
        </div>

        <!-- URL Input -->
        <div class="bg-gray-900 rounded-lg p-4 mb-6">
            <div class="flex gap-3">
                <input 
                    type="text" 
                    id="urlInput"
                    placeholder="Paste Whatnot stream URL (live or ended)..."
                    class="flex-1 px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button 
                    id="analyzeBtn"
                    onclick="analyzeStream()"
                    class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
                    Analyze Stream
                </button>
            </div>
            <div id="status" class="mt-3 text-sm"></div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden bg-gray-900 rounded-lg p-12 text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold">Analyzing stream...</p>
            <p class="text-gray-400 mt-2">Scraping chat and detecting buyers</p>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <!-- Summary Stats -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold" id="totalMessages">0</div>
                    <div class="text-sm opacity-90 mt-1">Total Messages</div>
                </div>
                <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold" id="totalBuyers">0</div>
                    <div class="text-sm opacity-90 mt-1">üí∞ Buyers Detected</div>
                </div>
                <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold" id="estimatedValue">$0</div>
                    <div class="text-sm opacity-90 mt-1">Estimated Value</div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-2 gap-6">
                <!-- Left: All Chat -->
                <div class="bg-gray-900 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Full Chat History</h2>
                    <div id="chatFeed" class="bg-gray-950 rounded-lg p-4 h-[600px] overflow-y-auto space-y-2">
                    </div>
                </div>

                <!-- Right: Missed Buyers -->
                <div class="bg-gray-900 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        Buyers You Missed
                        <span id="buyersCount" class="bg-red-600 text-white px-3 py-1 rounded-full text-sm">0</span>
                    </h2>
                    <div id="buyersList" class="space-y-3 h-[600px] overflow-y-auto">
                    </div>
                </div>
            </div>

            <!-- Export & CTA -->
            <div class="mt-6 flex gap-4">
                <button 
                    onclick="exportToCSV()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
                    üì• Export Buyers to CSV
                </button>
                <div class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <p class="font-bold text-lg">Never miss a buyer again</p>
                        <p class="text-sm opacity-90">Get real-time alerts during your next stream</p>
                    </div>
                    <button class="bg-white text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
                        Get Started - $99/mo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = null;

        async function analyzeStream() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            const status = document.getElementById('status');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (!url) {
                status.innerHTML = '<span class="text-red-400">Please enter a Whatnot stream URL</span>';
                return;
            }

            if (!url.includes('whatnot.com')) {
                status.innerHTML = '<span class="text-red-400">Please enter a valid Whatnot URL</span>';
                return;
            }

            // Show loading
            status.innerHTML = '';
            results.classList.add('hidden');
            loading.classList.remove('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';

            try {
                const response = await fetch('http://localhost:3001/api/scrape-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze stream');
                }

                analysisData = await response.json();

                // Hide loading, show results
                loading.classList.add('hidden');
                results.classList.remove('hidden');

                // Update stats
                document.getElementById('totalMessages').textContent = analysisData.totalMessages;
                document.getElementById('totalBuyers').textContent = analysisData.totalBuyers;
                document.getElementById('estimatedValue').textContent = `$${analysisData.estimatedValue}`;
                document.getElementById('buyersCount').textContent = analysisData.totalBuyers;

                // Display all messages
                const chatFeed = document.getElementById('chatFeed');
                chatFeed.innerHTML = '';

                analysisData.messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `chat-message bg-gray-800 rounded p-3 ${msg.isBuyer ? 'border-2 border-green-500' : ''}`;
                    msgDiv.innerHTML = `
                        <div class="flex items-start gap-2">
                            <div class="flex-1">
                                <span class="text-blue-400 font-semibold">${msg.username}</span>
                                <span class="text-gray-300 ml-2">${msg.message}</span>
                            </div>
                            ${msg.isBuyer ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full">üí∞ BUYER</span>' : ''}
                        </div>
                    `;
                    chatFeed.appendChild(msgDiv);
                });

                // Display buyers only
                const buyersList = document.getElementById('buyersList');
                buyersList.innerHTML = '';

                if (analysisData.buyers.length === 0) {
                    buyersList.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No buyers detected in this stream</p></div>';
                } else {
                    analysisData.buyers.forEach(buyer => {
                        const buyerDiv = document.createElement('div');
                        buyerDiv.className = 'bg-red-900/20 border border-red-500 rounded-lg p-4 chat-message';
                        buyerDiv.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-blue-400 font-semibold">${buyer.username}</span>
                                <span class="text-red-400 font-bold">‚ö†Ô∏è MISSED</span>
                            </div>
                            <div class="text-gray-300 text-sm">${buyer.message}</div>
                        `;
                        buyersList.appendChild(buyerDiv);
                    });
                }

                status.innerHTML = '<span class="text-green-400">‚úÖ Analysis complete!</span>';

            } catch (error) {
                loading.classList.add('hidden');
                status.innerHTML = `<span class="text-red-400">Error: ${error.message}. Make sure the scraper server is running (npm start)</span>`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Stream';
            }
        }

        function exportToCSV() {
            if (!analysisData || analysisData.buyers.length === 0) {
                alert('No buyers to export');
                return;
            }

            const headers = ['Username', 'Message', 'Timestamp'];
            const rows = analysisData.buyers.map(buyer => [
                buyer.username,
                buyer.message.replace(/,/g, ';'),
                new Date(buyer.timestamp).toLocaleString()
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dealflow-buyers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

