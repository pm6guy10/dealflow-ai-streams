<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DealFlow Live Demo</title>
    <script>
        window.DEALFLOW_API_BASE = 'https://dealflow-ai-streams.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse {
            animation: pulse 0.8s ease-in-out;
        }
        .glow {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.25);
        }
        .question-glow {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.35);
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.4);
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <div class="bg-gradient-to-br from-gray-900 via-gray-950 to-black">
        <header class="max-w-6xl mx-auto px-6 pt-12">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                    <div class="inline-flex items-center gap-2 bg-green-900/40 border border-green-500/40 text-green-300 px-4 py-1.5 rounded-full text-sm font-medium">
                        <span class="w-2.5 h-2.5 rounded-full bg-green-400 animate-pulse"></span>
                        <span>LIVE DATA ‚Ä¢ Pulled straight from Whatnot</span>
                    </div>
                    <h1 class="mt-4 text-4xl md:text-5xl font-bold text-white tracking-tight">
                        Watch DealFlow catch buyers on a real Whatnot stream
                    </h1>
                    <p class="mt-3 text-gray-400 text-lg md:text-xl max-w-2xl">
                        This demo is connected to <span id="streamName" class="font-semibold text-white">https://www.whatnot.com/live/b9a8b157-a819-4f84-8b97-b83c47fccb43</span>. 
                        Everything you see below is scraped live ‚Äì no canned data.
                    </p>
                    <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-gray-400">
                        <span class="inline-flex items-center gap-2 bg-gray-800/60 px-4 py-2 rounded-full">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            Monitoring in real time
                        </span>
                        <a class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300" href="https://www.whatnot.com/live/b9a8b157-a819-4f84-8b97-b83c47fccb43" target="_blank" rel="noopener noreferrer">
                            View the stream on Whatnot ‚Üó
                        </a>
                    </div>
                </div>
                <div class="bg-gray-900/70 border border-gray-800 rounded-2xl p-5 w-full md:max-w-xs">
                    <h2 class="text-sm uppercase tracking-wider text-gray-500 mb-3">Demo Stats</h2>
                    <dl class="space-y-3">
                        <div class="flex items-center justify-between">
                            <dt class="text-gray-400">Buyers Caught</dt>
                            <dd id="statBuyers" class="text-2xl font-bold text-green-400">0</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt class="text-gray-400">Messages Ingested</dt>
                            <dd id="statMessages" class="text-lg font-semibold text-blue-300">0</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt class="text-gray-400">Questions</dt>
                            <dd id="statQuestions" class="text-lg font-semibold text-orange-300">0</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt class="text-gray-400">Estimated Value</dt>
                            <dd id="statValue" class="text-lg font-semibold text-purple-300">$0</dd>
                        </div>
                    </dl>
                    <div class="mt-4 text-xs text-gray-500">
                        Powered by the same scraper you‚Äôll run during your own live auctions.
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-6 pb-16 mt-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Live Chat clone -->
                <section class="bg-gray-900/60 border border-gray-800 rounded-2xl overflow-hidden backdrop-blur">
                    <header class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1 text-yellow-300 text-lg">
                                <span>üü°</span><span class="font-semibold">LIVE CHAT CLONE</span>
                            </div>
                            <span class="text-xs text-gray-500" id="streamOrigin">(mirrors Whatnot feed in real time)</span>
                        </div>
                        <span id="demoStatus" class="text-sm text-gray-400">Connecting...</span>
                    </header>
                    <div class="h-[550px] overflow-y-auto scrollbar-thin" id="chatContainer">
                        <div class="flex items-center justify-center h-full text-gray-500 text-sm" id="chatPlaceholder">
                            Waiting for live messages...
                        </div>
                    </div>
                </section>

                <!-- DealFlow Buyer detection -->
                <section class="bg-gray-900/60 border border-gray-800 rounded-2xl overflow-hidden backdrop-blur">
                    <header class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1 text-green-300 text-lg">
                                <span>üí∞</span><span class="font-semibold">DEALFLOW BUYER QUEUE</span>
                            </div>
                            <span class="text-xs text-gray-500">Newest buyers appear at the top</span>
                        </div>
                        <button id="exportBtn" class="text-xs bg-gray-800 text-gray-400 px-3 py-1 rounded-full border border-gray-700 cursor-not-allowed" disabled>
                            Export CSV
                        </button>
                    </header>
                    <div class="h-[550px] overflow-y-auto scrollbar-thin" id="buyersContainer">
                        <div class="flex items-center justify-center h-full text-gray-500 text-sm" id="buyersPlaceholder">
                            Watching for buyer claims...
                        </div>
                    </div>
                </section>
            </div>

            <section class="mt-10 bg-gray-900/60 border border-gray-800 rounded-2xl p-8 backdrop-blur">
                <div class="grid md:grid-cols-3 gap-6 text-sm text-gray-400">
                    <div>
                        <h3 class="text-white font-semibold text-lg mb-2">See Whatnot. See DealFlow.</h3>
                        <p>Open the stream side by side and you‚Äôll notice this feed mirrors the real chat (including pace, usernames, and questions).</p>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-lg mb-2">Buyers auto-locked</h3>
                        <p>Whenever someone shouts ‚ÄúI‚Äôll take it‚Äù or drops a size, they snap into the green buyer stack with timestamp, confidence, and item notes.</p>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-lg mb-2">Questions glow orange</h3>
                        <p>We mirror Whatnot‚Äôs orange highlights by flagging any question mark chat. Sellers won‚Äôt miss critical pre-sale asks.</p>
                    </div>
                </div>
            </section>

            <section class="mt-10 text-center">
                <h2 class="text-3xl font-bold text-white mb-4">Ready for this on your own stream?</h2>
                <p class="text-gray-400 mb-6">Paste your link in the app or click below to try DealFlow on your next auction.</p>
                <a href="dealflow-realtime.html" class="inline-flex items-center gap-3 bg-green-500 hover:bg-green-400 text-black font-semibold px-10 py-4 rounded-full transition-all">
                    Launch DealFlow Monitor ‚Üí
                </a>
            </section>
        </main>
    </div>

    <script>
        const STREAM_URL = 'https://www.whatnot.com/live/b9a8b157-a819-4f84-8b97-b83c47fccb43';
        const SESSION_ID = 'dealflow_demo_session';
        const API_BASE = window.DEALFLOW_API_BASE || window.location.origin;
        let streamUrl = null;

        const chatContainer = document.getElementById('chatContainer');
        const buyersContainer = document.getElementById('buyersContainer');
        const chatPlaceholder = document.getElementById('chatPlaceholder');
        const buyersPlaceholder = document.getElementById('buyersPlaceholder');
        const statusLabel = document.getElementById('demoStatus');
        const exportBtn = document.getElementById('exportBtn');

        let ws;
        let connected = false;
        let buyers = [];
        let questionsCount = 0;
        let messagesCount = 0;
        let buyersDetected = 0;
        const allMessages = [];

        async function startDemoSession() {
            try {
                statusLabel.textContent = 'Connecting to DealFlow engine...';
                const response = await fetch(`${API_BASE}/api/start-monitoring`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: SESSION_ID, autoDiscover: true })
                });

                if (!response.ok) {
                    throw new Error('Failed to start monitoring session');
                }

                const data = await response.json();
                if (data.stream && data.stream.url) {
                    updateStreamDisplay(data.stream);
                }

                connectWebSocket();
            } catch (error) {
                console.error(error);
                statusLabel.textContent = 'Unable to connect. Is the DealFlow server running?';
                statusLabel.classList.add('text-red-400');
            }
        }

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsHost = (new URL(API_BASE)).host;
            ws = new WebSocket(`${wsProtocol}://${wsHost}`);

            ws.addEventListener('open', () => {
                connected = true;
                statusLabel.textContent = 'Streaming live data';
                statusLabel.classList.remove('text-red-400');
                statusLabel.classList.add('text-green-400');
            });

            ws.addEventListener('message', (event) => {
                const payload = JSON.parse(event.data);
                if (payload.sessionId !== SESSION_ID) return;

                if (payload.type === 'new_message') {
                    handleIncomingMessage(payload.message);
                } else if (payload.type === 'buyer_detected') {
                    handleBuyerDetected(payload.buyer, payload.stats);
                } else if (payload.type === 'stream_selected' && payload.stream) {
                    updateStreamDisplay(payload.stream);
                }
            });

            ws.addEventListener('close', () => {
                connected = false;
                statusLabel.textContent = 'Connection lost ‚Äì retrying...';
                statusLabel.classList.remove('text-green-400');
                statusLabel.classList.add('text-yellow-400');
                setTimeout(connectWebSocket, 2000);
            });
        }

        function handleIncomingMessage(message) {
            messagesCount++;
            document.getElementById('statMessages').textContent = messagesCount;

            const isQuestion = message.isQuestion;
            if (isQuestion) {
                questionsCount++;
                document.getElementById('statQuestions').textContent = questionsCount;
            }

            const messageEl = document.createElement('div');
            messageEl.className = `p-4 border-b border-gray-800 ${message.isBuyer ? 'bg-green-900/30 glow' : isQuestion ? 'bg-orange-900/30 question-glow' : 'bg-transparent'}`;
            messageEl.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-sm text-blue-300">${message.username}</span>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-sm text-gray-200 mt-1">${message.message}</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        ${message.isBuyer ? `<span class="text-xs bg-green-500 text-black font-semibold px-2 py-1 rounded-full">Buyer</span>` : ''}
                        ${isQuestion ? `<span class="text-xs bg-orange-500 text-white font-semibold px-2 py-1 rounded-full">Question</span>` : ''}
                    </div>
                </div>
            `;

            chatContainer.insertBefore(messageEl, chatContainer.firstChild);
            chatPlaceholder.classList.add('hidden');

            while (chatContainer.children.length > 100) {
                chatContainer.removeChild(chatContainer.lastChild);
            }

            allMessages.push({
                username: message.username,
                message: message.message,
                timestamp: message.timestamp,
                isBuyer: message.isBuyer,
                isQuestion
            });
        }

        function handleBuyerDetected(buyer, stats) {
            buyersDetected = stats.totalBuyers;
            document.getElementById('statBuyers').textContent = buyersDetected;
            document.getElementById('statValue').textContent = `$${(stats.estimatedValue || 0).toLocaleString()}`;

            const buyerEl = document.createElement('div');
            buyerEl.className = 'p-4 border-b border-green-500/40 bg-green-900/30 pulse';
            buyerEl.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-green-300">${buyer.username}</span>
                            <span class="text-xs text-gray-500">${new Date(buyer.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-sm text-gray-100 mt-1">${buyer.message}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400">Confidence</div>
                        <div class="text-lg font-bold text-green-300">${Math.round((buyer.confidence || 0) * 100)}%</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    Detected by keyword: <span class="text-green-300">${buyer.reason || 'intent phrase'}</span>
                </div>
            `;

            buyersContainer.insertBefore(buyerEl, buyersContainer.firstChild);
            buyersPlaceholder.classList.add('hidden');
            buyers.push(buyer);

            while (buyersContainer.children.length > 10) {
                buyersContainer.removeChild(buyersContainer.lastChild);
            }

            exportBtn.disabled = false;
            exportBtn.textContent = `Download ${buyersDetected} buyers (.csv)`;
            exportBtn.classList.remove('cursor-not-allowed', 'bg-gray-800', 'text-gray-400');
            exportBtn.classList.add('bg-green-500/20', 'text-green-300', 'border-green-500/50', 'hover:bg-green-500/30');
        }

        function updateStreamDisplay(stream) {
            streamUrl = stream.url;
            document.getElementById('streamName').textContent = stream.url;
            document.getElementById('streamOrigin').textContent = `(${stream.source === 'auto' ? 'auto-discovered top stream' : 'mirroring Whatnot feed'}${stream.viewers ? ` ‚Ä¢ ${stream.viewers.toLocaleString()} watching` : ''})`;
        }

        exportBtn.addEventListener('click', () => {
            if (buyers.length === 0) return;

            const header = ['username', 'message', 'confidence', 'reason', 'timestamp'];
            const rows = buyers.map(buyer => [
                buyer.username,
                buyer.message.replace(/"/g, '""'),
                buyer.confidence,
                buyer.reason,
                buyer.timestamp
            ]);

            const csvContent = [header, ...rows]
                .map(row => row.map(field => `"${field || ''}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dealflow-buyers-${Date.now()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        startDemoSession();
    </script>
</body>
</html>
 
